diagram {
	title = "Nuspell"

	io file_dic {
		title = "Dictionary file"
	}

boundary dic_data {
	title = "dic_data"

	function read_number {
		title = "Read number"
	}

	function read_line {
		title = "Read line"
	}

	function parse_line_slash {
		title = "Parse line with slash"
	}

	function parse_line_tab {
		title = "Parse line with tab"
	}

	function parse_line_colon {
		title = "Parse line with aa:"
	}

	function parse_line_simple {
		title = "Parse simple line"
	}

	function collect {
		title = `Collect
		         (word, flags, morph fields)`
	}

	function make_initcap {
		title = "Make init capital"
	}

	function add_hidden_homonym_flag {
		title = "Add hidden homonym flag"
	}

	function store_overwrite {
		title = "Store with overwrite"
	}

	function store_merge {
		title = "Store wth merge"
	}

	database set {
		title = "Word set D"
	}

	database flags {
		title = "Word, Flag relation D,F"
	}

	database morph {
		title = "Word, Morph field relation D,M"
	}

	function collect2 {
        title = "Collect 2"
	}
}

	file_dic -> read_number {
		operation = "read"
		data = "first line"
	}

	file_dic -> read_line {
		operation = "read"
		data = "line"
	}

	read_line -> read_line {
		operation = "read"
		data = "line"
	}

	read_line -> parse_line_slash  {
		operation = "IF has unescaped slash: parse"
		data = "line"

	}
	read_line -> parse_line_tab  {
		operation = "IF has tab: parse"
		data = "line"
	}
	read_line -> parse_line_colon {
		operation = "IF has char, char, colon: parse"
		data = "line"
	}

	read_line -> parse_line_simple {
		operation = "ELSE: parse"
		data = "line"
	}

	parse_line_slash -> collect  {
		operation = "collect"
		data = "(word, flags, morph fields)"
	}

	parse_line_tab -> collect  {
		operation = "collect"
		data = "(word, morph fields)"
	}
	parse_line_colon -> collect {
		operation = "collect"
		data = "(word, morph fields)"
	}
	parse_line_simple -> collect {
		operation = "collect"
		data = "word"
	}

	collect -> store_merge {
        operation = `IF (word exists AND is NOT hidden homonym)
                        or word NOT exist: store`
        data = "(word, flags, morph fields)"
	}

	store_merge -> set {
		operation = "store"
		data = "word"
	}
	store_merge -> flags {
		operation = "store"
		data = "word × flags"
	}
	store_merge -> morph {
		operation = "store"
		data = "word × morph fields"
	}

	collect -> store_overwrite {
        operation = `IF (word exists AND is hidden homonym):
                     store`
        data = "(word, flags, morph fields)"
	}

	store_overwrite -> set {
		operation = "store"
		data = "word"
	}
	store_overwrite -> flags {
		operation = "store"
		data = "word × flags"
	}
	store_overwrite -> morph {
		operation = "store"
		data = "word × morph fields"
	}

	collect -> make_initcap {
		operation = "make initcap"
		data = "word"
	}
	collect -> add_hidden_homonym_flag {
        operation = "add flag"
        data = "flags"
	}

    make_initcap -> collect2 {
        operation = "collect"
        data = "homonym initcap word"
    }

    add_hidden_homonym_flag -> collect2 {
        operation = "collect"
        data = "flags + homonym initcap flag"
    }

    collect2 -> store_merge {
        operation = `IF (NOT exist homonym) OR
                        found word is also hidden homonym:
                    store`
        data = "(homonym initcap word, flags + homonym initcap flag)"
    }

}
